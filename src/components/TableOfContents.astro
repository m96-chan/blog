---
---

<nav class="toc" aria-label="Table of Contents">
	<h2 class="toc-title">目次</h2>
	<ul class="toc-list" id="toc-list"></ul>
</nav>

<script>
	function initToc() {
		const tocList = document.getElementById('toc-list');
		if (!tocList) return;

		const contentArea = document.querySelector('.content');
		if (!contentArea) return;

		const headings = contentArea.querySelectorAll('h2[id], h3[id]');
		if (headings.length === 0) {
			const tocNav = tocList.closest('.toc');
			if (tocNav) tocNav.style.display = 'none';
			return;
		}

		// Build TOC items
		headings.forEach((heading) => {
			const li = document.createElement('li');
			li.className = heading.tagName === 'H3' ? 'toc-item toc-h3' : 'toc-item';

			const a = document.createElement('a');
			a.href = `#${heading.id}`;
			a.textContent = heading.textContent;
			a.className = 'toc-link';
			a.dataset.headingId = heading.id;

			a.addEventListener('click', (e) => {
				e.preventDefault();
				const target = document.getElementById(heading.id);
				if (target) {
					target.scrollIntoView({ behavior: 'smooth' });
					history.replaceState(null, '', `#${heading.id}`);
				}
			});

			li.appendChild(a);
			tocList.appendChild(li);
		});

		// Highlight active section with IntersectionObserver
		const observerCallback: IntersectionObserverCallback = (entries) => {
			entries.forEach((entry) => {
				if (entry.isIntersecting) {
					const id = entry.target.id;
					const links = tocList.querySelectorAll('.toc-link');
					links.forEach((link) => {
						if ((link as HTMLAnchorElement).dataset.headingId === id) {
							link.classList.add('active');
						} else {
							link.classList.remove('active');
						}
					});
				}
			});
		};

		const observer = new IntersectionObserver(observerCallback, {
			rootMargin: '-80px 0px -70% 0px',
			threshold: 0,
		});

		headings.forEach((heading) => observer.observe(heading));
	}

	// Run on initial load and on Astro page transitions
	initToc();
	document.addEventListener('astro:after-swap', initToc);
</script>

<style>
	.toc {
		position: sticky;
		top: 80px;
		max-height: calc(100vh - 100px);
		overflow-y: auto;
		padding: 16px 0;
	}

	.toc-title {
		font-size: 0.8rem;
		font-weight: 600;
		color: var(--text-secondary);
		text-transform: uppercase;
		letter-spacing: 0.08em;
		margin-bottom: 12px;
		padding-left: 12px;
	}

	.toc-list {
		list-style: none;
		padding: 0;
		margin: 0;
	}

	.toc-item {
		margin: 0;
	}

	.toc-h3 {
		padding-left: 12px;
	}

	.toc-link {
		display: block;
		padding: 4px 12px;
		font-size: 0.8rem;
		line-height: 1.5;
		color: var(--text-secondary);
		text-decoration: none;
		border-left: 2px solid transparent;
		transition: color 0.2s ease, border-color 0.2s ease;
	}

	.toc-link:hover {
		color: var(--text-primary);
	}

	.toc-link.active {
		color: var(--accent-light);
		border-left-color: var(--accent-light);
	}

	@media (max-width: 1100px) {
		.toc {
			display: none;
		}
	}
</style>
